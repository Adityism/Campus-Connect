<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Campus Connect AI Assistant</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Minimal reset + styling (same look as previous update) */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:#0f1113;color:#e6e7e8;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    :root{
      --muted:#9aa0a6;--primary:#0590ff;--user-bubble:linear-gradient(180deg,#0887ff,#0466cc);--ai-bubble:linear-gradient(180deg,#141414,#1a1a1a)
    }
    .app{display:grid;grid-template-columns:260px 1fr;gap:20px;height:100vh;padding:20px}
    .sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:12px;border:1px solid rgba(255,255,255,0.03)}
    .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(180deg,#2b2b2b,#181818);display:grid;place-items:center;color:#fff;font-weight:700;border:1px solid rgba(255,255,255,0.03)}
    .meta{display:flex;flex-direction:column}
    .meta .name{font-weight:600}
    .meta .email{font-size:12px;color:var(--muted);max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .controls{display:flex;gap:8px;margin-top:8px}
    .btn{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;color:#e9eef2;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.03)}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:9px;color:var(--muted);cursor:pointer}
    .nav-item:hover{background:rgba(255,255,255,0.02);color:#fff;transform:translateY(-1px)}
    .examples{margin-top:auto;display:flex;flex-direction:column;gap:8px}
    .example{background:rgba(255,255,255,0.02);padding:9px;border-radius:10px;color:var(--muted);cursor:pointer}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
    .panel .header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .title{font-weight:700;font-size:16px;display:flex;gap:12px;align-items:center}
    .chat{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:12px;background-image:repeating-linear-gradient(180deg,rgba(255,255,255,0.002) 0,rgba(255,255,255,0.002) 1px,transparent 1px,transparent 48px)}
    .message{padding:12px 14px;border-radius:12px;max-width:78%;font-size:14px;line-height:1.4}
    .user-message{margin-left:auto;background:var(--user-bubble);color:white;border-bottom-right-radius:6px}
    .assistant-message{margin-right:auto;background:var(--ai-bubble);color:#e6e7e8;border-bottom-left-radius:6px}
    .composer{padding:12px 18px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:12px;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,0.005),transparent)}
    .input{flex:1;display:flex;gap:8px;align-items:center;background:rgba(255,255,255,0.02);padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
    .input input[type="text"]{flex:1;background:transparent;border:0;outline:none;color:#e6e7e8;padding:8px;font-size:14px}
    .icon-btn{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01)}
    .send-btn{background:linear-gradient(180deg,var(--primary),#0077d6);border:none;padding:10px 14px;border-radius:10px;cursor:pointer;color:white;font-weight:700}
    #loading-indicator{display:none;color:var(--muted)}
    @media(max-width:900px){.app{grid-template-columns:1fr;padding:12px}.sidebar{order:2;flex-direction:row;overflow:auto;min-width:0;gap:10px;padding:10px}.panel{order:1;height:calc(100vh - 140px)}.examples{display:none}.nav{flex-direction:row;gap:8px}}
  </style>
</head>
<body>
  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="profile">
          <div class="avatar">C</div>
          <div class="meta">
            <div class="name">Aditya</div>
            <div class="email">aditya.107195@stu.upes.ac.in</div>
          </div>
        </div>
        <div>
          <button id="theme-toggle" class="btn" title="Toggle theme" aria-label="Toggle theme">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 3v2M12 19v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42M12 7a5 5 0 100 10 5 5 0 000-10z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </div>

      <div class="controls">
        <button id="new-chat-btn" class="btn">+ New Chat</button>
        <button id="sidebar-toggle" class="btn ghost" title="Toggle sidebar">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <nav class="nav" aria-label="Main nav">
        <div id="home-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M3 12l9-7 9 7v7a2 2 0 0 1-2 2h-4v-6H9v6H5a2 2 0 0 1-2-2z" fill="currentColor"/></svg><div>Home</div></div>
        <div id="saved-chats-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" fill="currentColor"/></svg><div>Saved Chats</div></div>
        <div id="suggestion-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0 0 14v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg><div>Suggestion</div></div>
        <div id="all-conversation-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="currentColor"/></svg><div>All Conversation</div></div>
        <div id="tips-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-4 12l1 2h6l1-2A7 7 0 0 0 12 2z" fill="currentColor"/></svg><div>Tips & Features</div></div>
        <div id="updates-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 2v6l4-4M6 22l6-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg><div>Updates & FAQs</div></div>
        <div id="customization-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg><div>Customization</div></div>
        <div id="upgrade-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 2l4 7h-8l4-7zM4 22h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg><div>Upgrade to Plus</div></div>
        <div id="logout-btn" class="nav-item" style="margin-top:6px"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M16 17l5-5-5-5M21 12H9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg><div>Logout</div></div>
      </nav>

      <div class="examples">
        <div class="example group-6 example-box" data-query="What are today's announcements?">What are today's announcements?</div>
        <div class="example group-6 example-box" data-query="Where is Shubhi Ma'am's office?">Where is Shubhi Ma'am's office?</div>
        <div class="example group-6 example-box" data-query="How do I make an HTTP request in JavaScript?">How do I make an HTTP request in JavaScript?</div>
      </div>
    </aside>

    <!-- MAIN PANEL -->
    <main class="panel" role="main">
      <div class="header">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#1b1b1b,#0f1113);display:grid;place-items:center;border:1px solid rgba(255,255,255,0.03);font-weight:700"><span style="font-size:18px;color:#fff">C</span></div>
          <div><div class="title">Campus Connect AI Assistant</div></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end"><div class="small-muted">Status: <span id="server-status">Ready</span></div></div>
      </div>

      <!-- Chat area and welcome area kept with same IDs -->
      <section id="chat-content" class="chat" aria-live="polite" style="display:none"></section>

      <div id="welcome-content" style="padding:18px;border-top:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg,transparent,rgba(255,255,255,0.01))">
        <div style="display:flex;gap:14px;align-items:flex-start">
          <div style="width:64px;height:64px;border-radius:8px;background:#141414;display:grid;place-items:center;color:#fff;font-weight:700">C</div>
          <div><div style="font-weight:700;font-size:16px;margin-bottom:6px">What can I help with?</div><div style="color:var(--muted)">Try the example prompts or start typing below.</div></div>
        </div>
      </div>

      <div class="composer" aria-label="Composer area">
        <div class="input" role="group" aria-label="Message input">
          <button id="mic-btn" class="icon-btn" aria-label="Mic">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 1v11a3 3 0 0 1-6 0V1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 11a7 7 0 0 1-14 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>

          <input id="user-query" type="text" placeholder="Type your message..." autocomplete="off" />

          <div id="loading-indicator" style="display:none">Loading...</div>

          <button id="send-btn" class="send-btn" title="Send message">Send</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Load your chat-handler.js exactly as it is. No interference. -->
  <!-- IMPORTANT: keep this path the same as your project. If chat-handler.js is not found, the console will show it. -->
  <script src="./static/js/chat-handler.js"></script>

  <!-- Small reliable glue that ensures send triggers the ChatHandler instance and shows chat UI -->
  <script>
    (function(){
      // Wait for chatHandler to be created by chat-handler.js (it initializes on DOMContentLoaded inside that file)
      function whenChatHandlerReady(timeout = 3000) {
        return new Promise((resolve, reject) => {
          const start = Date.now();
          function check() {
            if (window.chatHandler && typeof window.chatHandler.sendMessage === 'function') {
              return resolve(window.chatHandler);
            }
            if (Date.now() - start > timeout) return reject(new Error('chatHandler not initialized within timeout'));
            requestAnimationFrame(check);
          }
          check();
        });
      }

      // Wire UI elements to call chatHandler.sendMessage() and show chat panel before sending
      whenChatHandlerReady(5000).then(handler => {
        const sendBtn = document.getElementById('send-btn');
        const input = document.getElementById('user-query');
        const chat = document.getElementById('chat-content');
        const welcome = document.getElementById('welcome-content');

        function showChat() {
          if (welcome) welcome.style.display = 'none';
          if (chat) chat.style.display = 'flex';
        }

        // Ensure send button calls the handler directly
        if (sendBtn) {
          sendBtn.addEventListener('click', (e) => {
            // show chat immediately so messages from ChatHandler appear in visible area
            showChat();
            // call ChatHandler.sendMessage which uses the same #user-query field
            try {
              handler.sendMessage();
            } catch (err) {
              console.error('Error calling handler.sendMessage()', err);
            }
          });
        }

        // Enter key should trigger the handler too (ChatHandler already binds keypress; this is a safe duplicate)
        if (input) {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              showChat();
              try {
                handler.sendMessage();
              } catch (err) {
                console.error('Error calling handler.sendMessage() on Enter', err);
              }
            }
          });
        }

        // Example boxes trigger same flow
        document.querySelectorAll('.example-box').forEach(el => {
          el.addEventListener('click', () => {
            const q = el.getAttribute('data-query') || el.textContent.trim();
            if (input) input.value = q;
            showChat();
            try {
              handler.sendMessage();
            } catch (err) {
              console.error('Error calling handler.sendMessage() from example', err);
            }
          });
        });

        // Small feedback: when handler streams data it will update the chat; ensure chat scrolls
        const observer = new MutationObserver(() => {
          if (chat) chat.scrollTop = chat.scrollHeight;
        });
        if (chat) observer.observe(chat, { childList: true, subtree: true });

        console.log('Glue attached to existing ChatHandler.');
      }).catch(err => {
        // If chatHandler didn't initialize, still attach a fallback to send button that does nothing more than reveal UI
        console.warn('chatHandler not found:', err);
        const sendBtn = document.getElementById('send-btn');
        const input = document.getElementById('user-query');
        const chat = document.getElementById('chat-content');
        const welcome = document.getElementById('welcome-content');

        function showChat() { if (welcome) welcome.style.display = 'none'; if (chat) chat.style.display = 'flex'; }

        if (sendBtn) {
          sendBtn.addEventListener('click', () => {
            showChat();
            console.warn('chatHandler not initialized; message not sent to backend. Check console