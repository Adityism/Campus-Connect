<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Campus Connect AI Assistant</title>
<style>
  /* Minimal reset and core styles - high specificity to avoid external CSS interference */
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:#0f1113;color:#e6e7e8;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  :root{
    --muted:#9aa0a6;--primary:#0590ff;
    --user-grad:linear-gradient(180deg,#0887ff,#0466cc);
    --ai-grad:linear-gradient(180deg,#141414,#1a1a1a)
  }

  /* layout */
  .app{display:grid;grid-template-columns:260px 1fr;gap:20px;height:100vh;padding:20px}
  .sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:12px;border:1px solid rgba(255,255,255,0.03);min-width:200px}
  .profile{display:flex;gap:12px;align-items:center}
  .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(180deg,#2b2b2b,#181818);display:grid;place-items:center;color:#fff;font-weight:700;border:1px solid rgba(255,255,255,0.03)}
  .meta{display:flex;flex-direction:column}
  .meta .name{font-weight:600}
  .meta .email{font-size:12px;color:var(--muted);max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .controls{display:flex;gap:8px;margin-top:8px}
  .btn{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;color:#e9eef2;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.03)}
  .nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .nav-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:9px;color:var(--muted);cursor:pointer}
  .nav-item:hover{background:rgba(255,255,255,0.02);color:#fff;transform:translateY(-1px)}
  .examples{margin-top:auto;display:flex;flex-direction:column;gap:8px}
  .example{background:rgba(255,255,255,0.02);padding:9px;border-radius:10px;color:var(--muted);cursor:pointer}
  .example:hover{color:#fff}

  .panel{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
  .panel .header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .title{font-weight:700;font-size:16px;display:flex;gap:12px;align-items:center}
  .chat{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:12px;background-image:repeating-linear-gradient(180deg,rgba(255,255,255,0.002) 0,rgba(255,255,255,0.002) 1px,transparent 1px,transparent 48px)}
  .message{padding:12px 14px;border-radius:12px;max-width:78%;font-size:14px;line-height:1.4}
  .user-message{margin-left:auto;background:var(--user-grad);color:white;border-bottom-right-radius:6px}
  .assistant-message{margin-right:auto;background:var(--ai-grad);color:#e6e7e8;border-bottom-left-radius:6px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
  .composer{padding:12px 18px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:12px;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,0.005),transparent)}
  .input{flex:1;display:flex;gap:8px;align-items:center;background:rgba(255,255,255,0.02);padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  .input input[type="text"]{flex:1;background:transparent;border:0;outline:none;color:#e6e7e8;padding:8px;font-size:14px}
  .icon-btn{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01)}
  .send-btn{background:linear-gradient(180deg,var(--primary),#0077d6);border:none;padding:10px 14px;border-radius:10px;cursor:pointer;color:white;font-weight:700}
  #loading-indicator{display:none;color:var(--muted);font-size:13px}
  @media(max-width:900px){.app{grid-template-columns:1fr;padding:12px}.sidebar{order:2;flex-direction:row;overflow:auto;min-width:0;gap:10px;padding:10px}.panel{order:1;height:calc(100vh - 140px)}.examples{display:none}.nav{flex-direction:row;gap:8px}}
  /* message wrapper styles for created nodes */
  .message-row{display:flex;flex-direction:row}
</style>
</head>
<body>
  <div class="app">

    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="profile">
          <div class="avatar" aria-hidden> C </div>
          <div class="meta">
            <div class="name">Aditya</div>
            <div class="email">aditya.107195@stu.upes.ac.in</div>
          </div>
        </div>
        <div>
          <button id="theme-toggle" class="btn" title="Toggle theme" aria-label="Toggle theme">
            <!-- minimal icon -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 3v2M12 19v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42M12 7a5 5 0 100 10 5 5 0 000-10z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </div>

      <div class="controls">
        <button id="new-chat-btn" class="btn">+ New Chat</button>
        <button id="sidebar-toggle" class="btn ghost" title="Toggle sidebar">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <nav class="nav" aria-label="Main nav">
        <div id="home-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M3 12l9-7 9 7v7a2 2 0 0 1-2 2h-4v-6H9v6H5a2 2 0 0 1-2-2z" fill="currentColor"/></svg><div>Home</div></div>
        <div id="saved-chats-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" fill="currentColor"/></svg><div>Saved Chats</div></div>
        <div id="suggestion-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0 0 14v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg><div>Suggestion</div></div>
        <div id="all-conversation-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="currentColor"/></svg><div>All Conversation</div></div>
        <div id="tips-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-4 12l1 2h6l1-2A7 7 0 0 0 12 2z" fill="currentColor"/></svg><div>Tips & Features</div></div>
        <div id="updates-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 2v6l4-4M6 22l6-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg><div>Updates & FAQs</div></div>
        <div id="customization-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg><div>Customization</div></div>
        <div id="upgrade-btn" class="nav-item"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 2l4 7h-8l4-7zM4 22h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg><div>Upgrade to Plus</div></div>
        <div id="logout-btn" class="nav-item" style="margin-top:6px"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M16 17l5-5-5-5M21 12H9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg><div>Logout</div></div>
      </nav>

      <div class="examples">
        <div class="example group-6 example-box" data-query="What are today's announcements?">What are today's announcements?</div>
        <div class="example group-6 example-box" data-query="Where is Shubhi Ma'am's office?">Where is Shubhi Ma'am's office?</div>
        <div class="example group-6 example-box" data-query="How do I make an HTTP request in JavaScript?">How do I make an HTTP request in JavaScript?</div>
      </div>
    </aside>

    <!-- Main panel -->
    <main class="panel" role="main">
      <div class="header">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#1b1b1b,#0f1113);display:grid;place-items:center;border:1px solid rgba(255,255,255,0.03);font-weight:700"><span style="font-size:18px;color:#fff">C</span></div>
          <div><div class="title">Campus Connect AI Assistant</div></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end"><div class="small-muted">Status: <span id="server-status">Ready</span></div></div>
      </div>

      <!-- chat content (ChatHandler expects this ID) -->
      <section id="chat-content" class="chat" aria-live="polite" style="display:none;"></section>

      <!-- welcome content (ChatHandler expects this ID) -->
      <div id="welcome-content" style="padding:18px;border-top:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg,transparent,rgba(255,255,255,0.01))">
        <div style="display:flex;gap:14px;align-items:flex-start">
          <div style="width:64px;height:64px;border-radius:8px;background:#141414;display:grid;place-items:center;color:#fff;font-weight:700">C</div>
          <div><div style="font-weight:700;font-size:16px;margin-bottom:6px">What can I help with?</div><div style="color:var(--muted)">Try example prompts or start typing below.</div></div>
        </div>
      </div>

      <!-- composer (IDs kept) -->
      <div class="composer" aria-label="Composer area">
        <div class="input" role="group" aria-label="Message input">
          <button id="mic-btn" class="icon-btn" aria-label="Mic">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 1v11a3 3 0 0 1-6 0V1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 11a7 7 0 0 1-14 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>

          <input id="user-query" type="text" placeholder="Type your message..." autocomplete="off" />

          <div id="loading-indicator" aria-hidden>Loading...</div>

          <button id="send-btn" class="send-btn" title="Send message">Send</button>
        </div>
      </div>
    </main>
  </div>

<script>
/*
  Clean ChatHandler class. Uses the same streaming fetch logic you provided.
  Important: only one definition exists here. Initialization waits for DOM and
  attaches to the same IDs (#chat-content, #user-query, #send-btn, #loading-indicator).
*/
class ChatHandler {
  constructor(options = {}) {
    console.log("ChatHandler initialized");

    this.messageContainerSelector = options.messageContainer || '#chat-content';
    this.userInputFieldSelector = options.userInputField || '#user-query';
    this.sendButtonSelector = options.sendButton || '#send-btn';
    this.typingIndicatorSelector = options.typingIndicator || '#loading-indicator';
    this.apiEndpoint = options.apiEndpoint || '/api/query';

    this.messageContainer = document.querySelector(this.messageContainerSelector);
    this.userInputField = document.querySelector(this.userInputFieldSelector);
    this.sendButton = document.querySelector(this.sendButtonSelector);
    this.typingIndicator = document.querySelector(this.typingIndicatorSelector);

    console.log("Elements found:", {
      messageContainer: Boolean(this.messageContainer),
      userInputField: Boolean(this.userInputField),
      sendButton: Boolean(this.sendButton),
      typingIndicator: Boolean(this.typingIndicator)
    });

    this.messageHistory = [];
    this.isStreaming = false;

    this.init();
  }

  init() {
    if (this.sendButton) {
      // attach click listener directly to call this.sendMessage
      this.sendButton.addEventListener('click', (e) => {
        e.preventDefault();
        // reveal chat area
        const welcome = document.getElementById('welcome-content');
        const chat = document.getElementById('chat-content');
        if (welcome) welcome.style.display = 'none';
        if (chat) chat.style.display = 'flex';
        this.sendMessage();
      });
    }

    if (this.userInputField) {
      // on Enter, call sendMessage
      this.userInputField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          // reveal chat area
          const welcome = document.getElementById('welcome-content');
          const chat = document.getElementById('chat-content');
          if (welcome) welcome.style.display = 'none';
          if (chat) chat.style.display = 'flex';
          this.sendMessage();
        }
      });
    }

    // scroll observer (keeps chat scrolled to bottom)
    if (this.messageContainer) {
      const observer = new MutationObserver(() => {
        this.messageContainer.scrollTop = this.messageContainer.scrollHeight;
      });
      observer.observe(this.messageContainer, { childList: true, subtree: true });
    }
  }

  addUserMessage(content) {
    if (!this.messageContainer) return;
    const messageElement = document.createElement('div');
    messageElement.className = 'message user-message';
    messageElement.innerHTML = `<div>${this.escapeHTML(content)}</div>`;
    this.messageContainer.appendChild(messageElement);
    this.messageContainer.scrollTop = this.messageContainer.scrollHeight;
    this.messageHistory.push({ role: 'user', content });
  }

  createAssistantMessageContainer() {
    if (!this.messageContainer) return null;
    const messageElement = document.createElement('div');
    messageElement.className = 'message assistant-message';
    messageElement.innerHTML = '<div></div>';
    this.messageContainer.appendChild(messageElement);
    this.messageContainer.scrollTop = this.messageContainer.scrollHeight;
    return messageElement.querySelector('div');
  }

  updateAssistantMessage(element, content) {
    if (!element) return;
    element.innerHTML = this.formatMessage(content);
    if (this.messageContainer) this.messageContainer.scrollTop = this.messageContainer.scrollHeight;
  }

  formatMessage(text) {
    let formatted = this.escapeHTML(text || '');
    formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
    formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    formatted = formatted.replace(/\n/g, '<br>');
    return formatted;
  }

  escapeHTML(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async sendMessage() {
    if (!this.userInputField) return;
    const userInput = this.userInputField.value.trim();
    if (userInput === '' || this.isStreaming) return;

    // clear input and add user bubble
    this.userInputField.value = '';
    this.addUserMessage(userInput);

    // typing indicator
    if (this.typingIndicator) this.typingIndicator.style.display = 'inline';

    // assistant container
    const assistantEl = this.createAssistantMessageContainer();
    if (!assistantEl) {
      console.error("Could not create assistant message container");
      if (this.typingIndicator) this.typingIndicator.style.display = 'none';
      return;
    }

    try {
      this.isStreaming = true;
  // Send only the latest user message as 'prompt' for backend compatibility
  const lastUserMsg = this.messageHistory.filter(m => m.role === 'user').slice(-1)[0]?.content || '';
  const requestData = { prompt: lastUserMsg };

      // send to backend
      const response = await fetch(this.apiEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        const errText = await response.text().catch(()=>response.statusText);
        throw new Error(`HTTP ${response.status}: ${errText}`);
      }


  // Parse backend response as JSON and extract 'response' field
  const data = await response.json();
  const assistantResponse = typeof data.response === 'string' ? data.response : JSON.stringify(data);
  this.updateAssistantMessage(assistantEl, assistantResponse);
  // save assistant reply
  this.messageHistory.push({ role: 'assistant', content: assistantResponse });

    } catch (error) {
      console.error('Error in sendMessage:', error);
      this.updateAssistantMessage(assistantEl, 'Sorry, an error occurred while processing your request.');
    } finally {
      this.isStreaming = false;
      if (this.typingIndicator) this.typingIndicator.style.display = 'none';
    }
  }

  processChunk(chunk) {
    try {
      return chunk.split('\n')
        .filter(line => line.trim() !== '')
        .map(line => {
          const jsonStr = line.startsWith('data: ') ? line.slice(6) : line;
          try {
            const data = JSON.parse(jsonStr);
            return data.content || data.chunk || data.text || '';
          } catch (e) {
            return jsonStr;
          }
        })
        .join('');
    } catch (e) {
      return chunk;
    }
  }

  // optional utility: send file (kept for completeness)
  async sendFile(file) {
    if (!file) return;
    if (!this.messageContainer) return;
    const assistantEl = this.createAssistantMessageContainer();
    try {
      const fd = new FormData();
      fd.append('file', file);
      const resp = await fetch(this.apiEndpoint, { method: 'POST', body: fd });
      if (!resp.ok) throw new Error('File upload failed');
      const data = await resp.json();
      this.updateAssistantMessage(assistantEl, data.content || 'Uploaded');
      this.messageHistory.push({ role: 'assistant', content: data.content || '' });
    } catch (err) {
      console.error('sendFile error:', err);
      this.updateAssistantMessage(assistantEl, 'File upload failed.');
    }
  }
}

// expose globally
window.ChatHandler = ChatHandler;

// Initialize after DOM fully loaded
document.addEventListener('DOMContentLoaded', () => {
  try {
    window.chatHandler = new ChatHandler({
      messageContainer: '#chat-content',
      userInputField: '#user-query',
      sendButton: '#send-btn',
      typingIndicator: '#loading-indicator',
      apiEndpoint: '/api/query'
    });
    console.log('ChatHandler attached.');

    // Example boxes wiring: set input and trigger handler.sendMessage()
    document.querySelectorAll('.example-box').forEach(el => {
      el.addEventListener('click', () => {
        const q = el.getAttribute('data-query') || el.textContent.trim();
        const inp = document.querySelector('#user-query');
        if (!inp) return;
        inp.value = q;
        // reveal UI
        const welcome = document.getElementById('welcome-content');
        const chat = document.getElementById('chat-content');
        if (welcome) welcome.style.display = 'none';
        if (chat) chat.style.display = 'flex';
        // call send
        if (window.chatHandler && typeof window.chatHandler.sendMessage === 'function') {
          window.chatHandler.sendMessage();
        }
      });
    });

    // Side menu simple handlers (keeps original IDs)
    document.getElementById('new-chat-btn')?.addEventListener('click', () => {
      if (window.chatHandler && window.chatHandler.messageContainer) {
        window.chatHandler.messageContainer.innerHTML = '';
        window.chatHandler.messageHistory = [];
      }
      document.getElementById('welcome-content').style.display = 'block';
      document.getElementById('chat-content').style.display = 'none';
    });

    document.getElementById('home-btn')?.addEventListener('click', () => {
      document.getElementById('welcome-content').style.display = 'block';
      document.getElementById('chat-content').style.display = 'none';
    });

    // simple alerts for features not implemented
    ['saved-chats-btn','suggestion-btn','all-conversation-btn','tips-btn','updates-btn','customization-btn','upgrade-btn'].forEach(id=>{
      document.getElementById(id)?.addEventListener('click', ()=>{
        alert('Feature coming soon: ' + document.querySelector('#'+id+' div')?.innerText || id);
      });
    });

    document.getElementById('logout-btn')?.addEventListener('click', () => {
      if (confirm('Are you sure you want to logout?')) window.location.href = '/logout';
    });

  } catch (e) {
    console.error('Failed to initialize ChatHandler:', e);
  }
});
</script>
</body>
</html>